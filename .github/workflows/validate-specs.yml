# Validate Specifications Workflow
# Validates OpenAPI, AsyncAPI, Protobuf, and JSON Schema files
# Handles multi-file specs with bundling before validation

name: Validate Specifications

on:
  pull_request:
    paths:
      - 'specs/**'
      - 'openapi.yaml'
      - '.github/workflows/validate-specs.yml'
  push:
    branches: [main]
    paths:
      - 'specs/**'
  workflow_dispatch:

concurrency:
  group: validate-specs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-openapi:
    name: Lint OpenAPI Spec
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Redocly CLI
        run: npm install -g @redocly/cli

      - name: Check for OpenAPI spec
        id: check
        run: |
          if [ -f "specs/openapi/openapi.yaml" ]; then
            echo "spec_path=specs/openapi/openapi.yaml" >> $GITHUB_OUTPUT
            echo "has_spec=true" >> $GITHUB_OUTPUT
          elif [ -f "specs/openapi.yaml" ]; then
            echo "spec_path=specs/openapi.yaml" >> $GITHUB_OUTPUT
            echo "has_spec=true" >> $GITHUB_OUTPUT
          elif [ -f "openapi.yaml" ]; then
            echo "spec_path=openapi.yaml" >> $GITHUB_OUTPUT
            echo "has_spec=true" >> $GITHUB_OUTPUT
          else
            echo "has_spec=false" >> $GITHUB_OUTPUT
            echo "No OpenAPI spec found. Skipping."
          fi

      - name: Bundle multi-file OpenAPI spec
        if: steps.check.outputs.has_spec == 'true'
        run: |
          set -euo pipefail
          SPEC="${{ steps.check.outputs.spec_path }}"

          # Bundle multi-file spec into single file for validation
          redocly bundle "$SPEC" -o /tmp/bundled-openapi.yaml || {
            echo "::warning::Bundling failed, trying direct validation"
            cp "$SPEC" /tmp/bundled-openapi.yaml
          }

      - name: Lint bundled OpenAPI Spec
        if: steps.check.outputs.has_spec == 'true'
        run: |
          set -euo pipefail
          # Lint with reduced severity for generated files
          redocly lint /tmp/bundled-openapi.yaml \
            --format github-actions \
            --skip-rule no-unused-components || echo "::warning::Lint issues found (non-blocking for generated specs)"
        continue-on-error: true

      - name: Validate OpenAPI Schema
        if: steps.check.outputs.has_spec == 'true'
        run: |
          npm install -g @apidevtools/swagger-cli
          swagger-cli validate /tmp/bundled-openapi.yaml || {
            echo "::warning::Schema validation had issues"
          }
        continue-on-error: true

  lint-asyncapi:
    name: Lint AsyncAPI Spec
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for AsyncAPI specs
        id: check
        run: |
          if compgen -G "specs/asyncapi/*.yaml" > /dev/null 2>&1 || \
             compgen -G "specs/asyncapi/*.yml" > /dev/null 2>&1; then
            echo "has_specs=true" >> $GITHUB_OUTPUT
          else
            echo "has_specs=false" >> $GITHUB_OUTPUT
            echo "No AsyncAPI specs found. Skipping."
          fi

      - name: Setup Node.js
        if: steps.check.outputs.has_specs == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install AsyncAPI CLI
        if: steps.check.outputs.has_specs == 'true'
        run: npm install -g @asyncapi/cli

      - name: Validate AsyncAPI
        if: steps.check.outputs.has_specs == 'true'
        run: |
          set -euo pipefail
          FOUND=0
          for file in specs/asyncapi/*.yaml specs/asyncapi/*.yml; do
            if [ -f "$file" ]; then
              FOUND=1
              echo "Validating $file"
              asyncapi validate "$file" || echo "::warning::Validation issues in $file"
            fi
          done
          if [ "$FOUND" -eq 0 ]; then
            echo "No AsyncAPI files to validate"
          fi
        continue-on-error: true

  lint-protobuf:
    name: Lint Protobuf
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Protobuf specs
        id: check
        run: |
          if compgen -G "specs/protobuf/*.proto" > /dev/null 2>&1; then
            echo "has_protos=true" >> $GITHUB_OUTPUT
          else
            echo "has_protos=false" >> $GITHUB_OUTPUT
            echo "No Protobuf specs found. Skipping."
          fi

      - name: Setup Buf
        if: steps.check.outputs.has_protos == 'true'
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Lint Protobuf
        if: steps.check.outputs.has_protos == 'true'
        run: |
          set -euo pipefail
          cd specs/protobuf

          # Use buf.yaml if present, otherwise use inline config
          if [ -f "buf.yaml" ]; then
            buf lint || echo "::warning::Buf lint found issues"
          else
            buf lint --config '{"version":"v2","lint":{"use":["DEFAULT"],"except":["PACKAGE_VERSION_SUFFIX"]}}' \
              || echo "::warning::Buf lint found issues"
          fi
        continue-on-error: true

  validate-json-schemas:
    name: Validate JSON Schemas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for JSON Schemas
        id: check
        run: |
          if compgen -G "specs/json-schema/*.schema.json" > /dev/null 2>&1 || \
             compgen -G "specs/artifacts/*.schema.json" > /dev/null 2>&1 || \
             compgen -G "specs/*.schema.json" > /dev/null 2>&1; then
            echo "has_schemas=true" >> $GITHUB_OUTPUT
          else
            echo "has_schemas=false" >> $GITHUB_OUTPUT
            echo "No JSON Schemas found. Skipping."
          fi

      - name: Setup Node.js
        if: steps.check.outputs.has_schemas == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ajv-cli
        if: steps.check.outputs.has_schemas == 'true'
        run: npm install -g ajv-cli ajv-formats

      - name: Validate JSON Schemas
        if: steps.check.outputs.has_schemas == 'true'
        run: |
          set -euo pipefail
          FOUND=0

          for schema in specs/json-schema/*.schema.json specs/artifacts/*.schema.json specs/*.schema.json; do
            if [ -f "$schema" ]; then
              FOUND=1
              echo "Validating schema: $schema"
              ajv compile -s "$schema" --spec=draft2020 -c ajv-formats 2>/dev/null || \
              ajv compile -s "$schema" --spec=draft-07 -c ajv-formats || \
                echo "::warning::Schema $schema had validation issues"
            fi
          done

          if [ "$FOUND" -eq 0 ]; then
            echo "No JSON schema files found to validate"
          fi
        continue-on-error: true

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [lint-openapi, lint-asyncapi, lint-protobuf, validate-json-schemas]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "## Specification Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.lint-openapi.result }}" == "success" ]; then
            echo "✅ OpenAPI validation passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.lint-openapi.result }}" == "skipped" ]; then
            echo "⏭️ OpenAPI validation skipped (no spec)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ OpenAPI validation: ${{ needs.lint-openapi.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.lint-asyncapi.result }}" == "success" ]; then
            echo "✅ AsyncAPI validation passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.lint-asyncapi.result }}" == "skipped" ]; then
            echo "⏭️ AsyncAPI validation skipped (no spec)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ AsyncAPI validation: ${{ needs.lint-asyncapi.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.lint-protobuf.result }}" == "success" ]; then
            echo "✅ Protobuf validation passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.lint-protobuf.result }}" == "skipped" ]; then
            echo "⏭️ Protobuf validation skipped (no protos)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Protobuf validation: ${{ needs.lint-protobuf.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-json-schemas.result }}" == "success" ]; then
            echo "✅ JSON Schema validation passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validate-json-schemas.result }}" == "skipped" ]; then
            echo "⏭️ JSON Schema validation skipped (no schemas)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ JSON Schema validation: ${{ needs.validate-json-schemas.result }}" >> $GITHUB_STEP_SUMMARY
          fi
