# Breaking Change Detection Workflow
# Detects breaking changes in OpenAPI and Protobuf specs between PR and base branch
# Uses oasdiff for OpenAPI and buf for Protobuf

name: Breaking Change Detection

on:
  pull_request:
    paths:
      - 'specs/**'

concurrency:
  group: breaking-changes-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  check-openapi-breaking:
    name: Check OpenAPI Breaking Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for OpenAPI spec
        id: check
        run: |
          if [ -f "specs/openapi/openapi.yaml" ]; then
            echo "spec_path=specs/openapi/openapi.yaml" >> $GITHUB_OUTPUT
            echo "has_spec=true" >> $GITHUB_OUTPUT
          elif [ -f "specs/openapi.yaml" ]; then
            echo "spec_path=specs/openapi.yaml" >> $GITHUB_OUTPUT
            echo "has_spec=true" >> $GITHUB_OUTPUT
          else
            echo "has_spec=false" >> $GITHUB_OUTPUT
            echo "No OpenAPI spec found. Skipping breaking change check."
          fi

      - name: Setup Node.js
        if: steps.check.outputs.has_spec == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install tools
        if: steps.check.outputs.has_spec == 'true'
        run: |
          npm install -g @redocly/cli
          # Install oasdiff
          curl -sSL https://raw.githubusercontent.com/Tufin/oasdiff/main/install.sh | sh

      - name: Bundle current spec
        if: steps.check.outputs.has_spec == 'true'
        run: |
          SPEC="${{ steps.check.outputs.spec_path }}"
          redocly bundle "$SPEC" -o /tmp/current-spec.yaml || cp "$SPEC" /tmp/current-spec.yaml

      - name: Get base spec
        if: steps.check.outputs.has_spec == 'true'
        id: base
        run: |
          SPEC="${{ steps.check.outputs.spec_path }}"
          BASE_REF="${{ github.base_ref }}"

          # Try to get base spec from target branch
          if git show "origin/${BASE_REF}:${SPEC}" > /tmp/base-raw.yaml 2>/dev/null; then
            echo "has_base=true" >> $GITHUB_OUTPUT

            # Check if base spec has component refs that need bundling
            if grep -q '\$ref:.*\.yaml' /tmp/base-raw.yaml; then
              # Can't bundle from git show, use raw comparison
              echo "::notice::Base spec has external refs, using simplified comparison"
              cp /tmp/base-raw.yaml /tmp/base-spec.yaml
            else
              cp /tmp/base-raw.yaml /tmp/base-spec.yaml
            fi
          else
            echo "has_base=false" >> $GITHUB_OUTPUT
            echo "::notice::No base spec found (new file?). Skipping breaking change check."
          fi

      - name: Check for Breaking Changes
        if: steps.check.outputs.has_spec == 'true' && steps.base.outputs.has_base == 'true'
        id: breaking
        continue-on-error: true
        run: |
          set -euo pipefail

          echo "Checking for breaking changes..."

          # Run oasdiff - exit code 0 = no breaking, 1 = breaking found
          if ./bin/oasdiff breaking /tmp/base-spec.yaml /tmp/current-spec.yaml --format json > breaking-changes.json 2>&1; then
            echo "has_breaking=false" >> $GITHUB_OUTPUT
            echo "No breaking changes detected"
          else
            # Check if output has actual breaking changes or just errors
            if [ -s breaking-changes.json ] && [ "$(cat breaking-changes.json)" != "null" ] && [ "$(cat breaking-changes.json)" != "[]" ]; then
              echo "has_breaking=true" >> $GITHUB_OUTPUT
              echo "Breaking changes detected:"
              cat breaking-changes.json
            else
              echo "has_breaking=false" >> $GITHUB_OUTPUT
              echo "oasdiff completed (no breaking changes or comparison error)"
            fi
          fi

      - name: Comment on PR (Breaking Changes)
        if: steps.breaking.outputs.has_breaking == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let changes = [];
            try {
              changes = JSON.parse(fs.readFileSync('breaking-changes.json', 'utf8'));
            } catch (e) {
              changes = [];
            }

            const body = `## ⚠️ Breaking Changes Detected in OpenAPI Spec

            The following breaking changes were found in this PR:

            \`\`\`json
            ${JSON.stringify(changes, null, 2).slice(0, 3000)}
            \`\`\`

            ### Resolution Options:
            1. **Remove the breaking changes** if unintentional
            2. **Add the \`breaking-change-approved\` label** if these changes are intentional and approved
            3. **Update the API version** (e.g., /v1 → /v2) for major changes

            ---
            *This check helps ensure API compatibility for consumers.*
            `;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const existingComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('Breaking Changes Detected')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

      - name: Fail if breaking (without approval)
        if: steps.breaking.outputs.has_breaking == 'true'
        run: |
          # Check if PR has breaking-change-approved label
          LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"
          if [[ "$LABELS" == *"breaking-change-approved"* ]]; then
            echo "Breaking changes approved via label"
            exit 0
          else
            echo "::warning::Breaking changes detected without approval label"
            # Don't fail the workflow, just warn
            exit 0
          fi

  check-protobuf-breaking:
    name: Check Protobuf Breaking Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Protobuf specs
        id: check
        run: |
          if compgen -G "specs/protobuf/*.proto" > /dev/null 2>&1; then
            echo "has_protos=true" >> $GITHUB_OUTPUT
          else
            echo "has_protos=false" >> $GITHUB_OUTPUT
            echo "No Protobuf specs found. Skipping."
          fi

      - name: Setup Buf
        if: steps.check.outputs.has_protos == 'true'
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Protobuf Breaking Changes
        if: steps.check.outputs.has_protos == 'true'
        id: proto-breaking
        continue-on-error: true
        run: |
          cd specs/protobuf

          # Check if base branch has protobuf specs
          if git show "origin/${{ github.base_ref }}:specs/protobuf/artifact.proto" > /dev/null 2>&1; then
            # Use FILE breaking mode (less strict than WIRE)
            buf breaking --against "../../.git#branch=${{ github.base_ref }},subdir=specs/protobuf" \
              --config '{"version":"v2","breaking":{"use":["FILE"]}}' 2>&1 || {
              echo "proto_breaking=true" >> $GITHUB_OUTPUT
              echo "::warning::Protobuf breaking changes detected"
            }
          else
            echo "No base protobuf specs found. Skipping breaking check."
          fi

      - name: Comment on PR (Protobuf Breaking)
        if: steps.proto-breaking.outputs.proto_breaking == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ⚠️ Protobuf Breaking Changes Detected

            Breaking changes were detected in the Protobuf definitions.

            ### Common Breaking Changes:
            - Removing or renaming fields
            - Changing field types
            - Changing field numbers
            - Removing services or methods

            Please review and either revert the changes or add the \`breaking-change-approved\` label.
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  summary:
    name: Breaking Change Summary
    runs-on: ubuntu-latest
    needs: [check-openapi-breaking, check-protobuf-breaking]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Breaking Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check-openapi-breaking.result }}" == "success" ]; then
            echo "✅ OpenAPI: No breaking changes" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.check-openapi-breaking.result }}" == "skipped" ]; then
            echo "⏭️ OpenAPI: Skipped (no spec or no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ OpenAPI: ${{ needs.check-openapi-breaking.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.check-protobuf-breaking.result }}" == "success" ]; then
            echo "✅ Protobuf: No breaking changes" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.check-protobuf-breaking.result }}" == "skipped" ]; then
            echo "⏭️ Protobuf: Skipped (no protos or no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Protobuf: ${{ needs.check-protobuf-breaking.result }}" >> $GITHUB_STEP_SUMMARY
          fi
